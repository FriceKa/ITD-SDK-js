/**
 * –ü—Ä–∏–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞ —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º turnstileToken —á–µ—Ä–µ–∑ Puppeteer
 */
import { ITDClient } from '../src/client.js';
import { getTurnstileToken, getTurnstileTokenInteractive } from '../src/turnstile-helper.js';
import dotenv from 'dotenv';

dotenv.config();

async function autoLogin() {
    console.log('=== –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ —Å Puppeteer ===\n');
    
    const client = new ITDClient();
    const email = process.env.ITD_USERNAME || 'your_email@example.com';
    const password = process.env.ITD_PASSWORD || 'your_password';
    
    console.log('1Ô∏è‚É£ –ü–æ–ª—É—á–∞—é —Å–≤–µ–∂–∏–π turnstileToken —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä...\n');
    
    // –ü—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º
    let turnstileToken = await getTurnstileToken();
    
    // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å - –ø—Ä–æ–±—É–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π
    if (!turnstileToken) {
        console.log('\n2Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª. –ü—Ä–æ–±—É—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π...\n');
        turnstileToken = await getTurnstileTokenInteractive();
    }
    
    if (!turnstileToken) {
        console.log('\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
        console.log('üí° –ü–æ–ø—Ä–æ–±—É–π –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞');
        return;
    }
    
    console.log(`\n‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${turnstileToken.substring(0, 50)}...\n`);
    console.log('3Ô∏è‚É£ –í—ã–ø–æ–ª–Ω—è—é –≤—Ö–æ–¥...\n');
    
    if (await client.login(email, password, turnstileToken)) {
        console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!\n');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ refresh —Ä–∞–±–æ—Ç–∞–µ—Ç
        console.log('4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è—é refresh —Ç–æ–∫–µ–Ω...\n');
        const refreshed = await client.refreshAccessToken();
        if (refreshed) {
            console.log('‚úÖ Refresh —Ç–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ Turnstile\n');
        } else {
            console.log('‚ö†Ô∏è  Refresh –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω—ã cookies –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞)\n');
        }
        
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç—ã
        console.log('5Ô∏è‚É£ –ü–æ–ª—É—á–∞—é –ø–æ—Å—Ç—ã...\n');
        const posts = await client.getPosts(5, 0);
        console.log(`–ù–∞–π–¥–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: ${posts.length}\n`);
        
        if (posts.length > 0) {
            console.log('–ü–µ—Ä–≤—ã–π –ø–æ—Å—Ç:', JSON.stringify(posts[0], null, 2).substring(0, 200));
        }
        
    } else {
        console.log('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
    }
}

(async () => {
    try {
        await autoLogin();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
    }
})();
